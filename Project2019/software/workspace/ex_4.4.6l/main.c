#include <msp430.h>
#include "MacroAndConst.h"


#define XT2_FREQ   4000000
#define MCLK_FREQ 16000000
#define SMCLK_FREQ 4000000

int time = 0;

#define ADN 12
unsigned Filter0()
{
    char count, i, j;
    volatile unsigned int value_buf[ADN];
    volatile unsigned int temp=0;
    int sum = 0;

    ADC12CTL0 |=ADC12SC;
    for (count = 0; count < ADN; count++)
    {
        value_buf[count] = ADC12MEM0;
        __delay_cycles(10);
    }
    for (j=0;j<ADN-1;j++)
    {
        for (i=0;i<ADN-j-1;i++)
        {
            if ( value_buf[i]>value_buf[i+1] )
            {
                temp = value_buf[i];
                value_buf[i] = value_buf[i+1];
                value_buf[i+1] = temp;
            }
        }
    }
    for(count=1;count<ADN-1;count++)
    sum += value_buf[count];
    return (unsigned)(sum/(ADN-2));
}

void timea()//³õÊ¼»¯¶¨Ê±Æ÷timerA
{

        TA0CTL= TACLR+TASSEL_1+MC_1;      // ACLK, Çå³ý TAR,Ôö¼ÆÊýÄ£Ê½
        TA0CCR0 = 0x8000;     // PWMÖÜÆÚ
        TA0CCTL0=CCIE;//¿ªÆôtimerAÖÐ¶Ï
}

void ioinit()
{

     P3DIR |= BIT5+BIT7;     //ÅäÖÃGPIOÒý½ÅP3.5(TB0.5)¡¢P3.7(TB0OUTH/SVMOUT)ÎªÊä³ö·½Ïò
     P7DIR |= BIT4;            //ÅäÖÃGPIOÒý½ÅP7.4(TB0.2)ÎªÊä³ö·½Ïò

     P8DIR |= BIT1;            //ÅäÖÃGPIOÒý½ÅP8.1ÎªÊä³ö·½Ïò
     P3DIR |= BIT7;
     P7DIR |= BIT4;
     P6DIR |= BIT3;
     P6DIR |= BIT4;
     P3DIR |= BIT5;

     SET(P1DIR,BIT5);
     SET(P2DIR,(BIT2+BIT4+BIT5));// P2.2ÎªSMCLKÊä³ö
     P2OUT &= ~BIT2;                    //SMCLK

     P1REN |= BIT2+BIT3;                 //Ê¹ÄÜS1£¬S2µÄÉÏÏÂÀ­µç×è
     P1OUT |= BIT2+BIT3;                 //ÉèÖÃS1£¬S2ÎªÉÏÀ­×´Ì¬

      P2DIR |= BIT4+BIT5;                       // P2.4 and P2.5 output
      P2SEL |= BIT4;//+BIT5;                           // P2.4 and P2.5 options select ÍâÉè¸ø¶¨Ê±Æ÷TA2.1

}

void InitAD()
{
     ADC12CTL0 |= ADC12MSC;//×Ô¶¯Ñ­»·²ÉÑù×ª»»
     ADC12CTL0 |= ADC12ON;//Æô¶¯ADC12Ä£¿é
     ADC12CTL1 |= ADC12CONSEQ_3 ;//Ñ¡ÔñÐòÁÐÍ¨µÀ¶à´ÎÑ­»·²ÉÑù×ª»»
     ADC12CTL1 |= ADC12SHP;   //²ÉÑù±£³ÖÄ£Ê½
     ADC12CTL1  |= ADC12CSTARTADD_0;
     ADC12MCTL0 |=ADC12INCH_0;//Í¨µÀÑ¡Ôñ
     ADC12MCTL1 |=ADC12INCH_1+ADC12EOS;
     ADC12CTL0 |= ADC12ENC;
}
void initClock()
{//×îÖÕÐ§¹û£ºMCLK:16MHZ,SMCLK:8MHZ,ACLK:32KHZ
     UCSCTL6 &= ~XT1OFF;          //Æô¶¯XT1
     P5SEL |= BIT2 + BIT3;        //XT2Òý½Å¹¦ÄÜÑ¡Ôñ
     UCSCTL6 &= ~XT2OFF;          //´ò¿ªXT2

     //ÉèÖÃÏµÍ³Ê±ÖÓÉú³ÉÆ÷1,FLL control loop¹Ø±ÕSCG0=1,¹Ø±ÕËøÆµ»·£¬ÓÃ»§×Ô¶¨ÒåUCSCTL0~1¹¤×÷Ä£Ê½
     __bis_SR_register(SCG0);

     //ÊÖ¶¯Ñ¡ÔñDCOÆµÂÊ½×ÌÝ£¨8ÖÖ½×ÌÝ£©£¬È·¶¨DCOÆµÂÊ´óÖÂ·¶Î§¡£
     UCSCTL0 = DCO0+DCO1+DCO2+DCO3+DCO4;
     //DCOÆµÂÊ·¶Î§ÔÚ28.2MHzÒÔÏÂ£¬DCOÆµÂÊ·¶Î§Ñ¡Ôñ£¨Èý¸öbitÎ»£¬¸Ä±äÖ±Á÷·¢ÉúÆ÷µçÑ¹£¬½ø¶ø¸Ä±äDCOÊä³öÆµÂÊ£©
     UCSCTL1 = DCORSEL_4;
     //fDCOCLK/32£¬ËøÆµ»··ÖÆµÆ÷
     UCSCTL2 = FLLD_5;

     //n=8,FLLREFCLKÊ±ÖÓÔ´ÎªXT2CLK
     //DCOCLK=D*(N+1)*(FLLREFCLK/n)
     //DCOCLKDIV=(N+1)*(FLLREFCLK/n)
     UCSCTL3 = SELREF_5 + FLLREFDIV_3;
     //ACLKµÄÊ±ÖÓÔ´ÎªDCOCLKDIV,MCLK\SMCLKµÄÊ±ÖÓÔ´ÎªDCOCLK
     UCSCTL4 = SELA_4 + SELS_3 +SELM_3;
     //ACLKÓÉDCOCLKDIVµÄ32·ÖÆµµÃµ½£¬SMCLKÓÉDCOCLKµÄ2·ÖÆµµÃµ½
     UCSCTL5 = DIVA_5 +DIVS_1;

     //  __bic_SR_register(SCG0);   //Enable the FLL control loop
}

int main(void)
{
    WDTCTL = WDTPW | WDTHOLD;   // Stop watchdog timer

    P8OUT &=~ BIT1;
    P3OUT &=~ BIT7;
    P7OUT &=~ BIT4;
    P6OUT &=~ BIT3;
    P6OUT &=~ BIT4;
    P3OUT &=~ BIT5;

    timea();
    initClock();
    ioinit();
    InitAD();

    unsigned int Period=512;            //PWM Period
    unsigned int duty=0;                //PWM duty cycle (%)
    TA2CCR0 = Period+1;                            // PWM Period
    TA2CCTL1 = OUTMOD_6;                      // CCR1 toggle/set ·­×ª/ÖÃÎ»
    TA2CCR1 = Period*duty/100;                // CCR1 PWM duty cycle
    TA2CTL = TASSEL_2 + MC_3 + TACLR;         // SMCLK, up-down mode, clear TAR

    __no_operation();                         // For debugger
    __delay_cycles(MCLK_FREQ*2);
    __enable_interrupt();              //¿ªÆôÈ«¾ÖÖÐ¶Ï


    volatile unsigned int sound_value = 0;                                                //ÉèÖÃÅÐ¶Ï±äÁ¿
    volatile unsigned int light_value = 0;                                                //ÉèÖÃÅÐ¶Ï±äÁ¿
    while(1)
    {//
        ADC12CTL0 |=ADC12SC;                                                       //¿ªÊ¼²ÉÑù×ª»»£¬ADC12SC
        sound_value = Filter0();                                                          //°Ñ½á¹û¸³¸ø±äÁ¿£¬½á¹ûÔÚADC12MEM0
        light_value =ADC12MEM1;                                                          //°Ñ½á¹û¸³¸ø±äÁ¿£¬½á¹ûÔÚADC12MEM1

        if(time<20)
        {
            SET(P1OUT,BIT5);
            SET(P2OUT,BIT5);
        }
        else
        {
            CLR(P1OUT,BIT5);
            CLR(P2OUT,BIT5);
        }

        if(sound_value>2450)
        {
            time=0;
            P6OUT |=BIT4;
        }else
        {
            P6OUT &=~ BIT4;
        }

        if(light_value >=1500)                                                                   //ÅÐ¶Ï½á¹û·¶Î§
            {
                         duty=30;
                         TA2CCR1= Period*duty/100;                   // CCR1 PWM duty cycle
                         P8OUT |= BIT1;                                   // LED1ÁÁ
            }
        else
            P8OUT &=~ BIT1;                                  // LED1Ãð
        if(light_value >2000)
        {
                     duty=45;
                     TA2CCR1 = Period*duty/100;                   // CCR1 PWM duty cycle
                     P3OUT |= BIT7;                                   // LED1ÁÁ
        }
        else
            P3OUT &=~ BIT7;;                                  // LED2Ãð
        if(light_value >= 2500)
        {
                     duty=60;
                     TA2CCR1 = Period*duty/100;                   // CCR1 PWM duty cycle
                     P7OUT |= BIT4;                                   // LED1ÁÁ
        }
        else
            P7OUT &=~ BIT4;                                   // LED3Ãð
        if(light_value >= 3000)
        {
                     duty=75;
                     TA2CCR1 = Period*duty/100;                   // CCR1 PWM duty cycle
                     P6OUT |= BIT3;                                   // LED1ÁÁ
        }
        else
            P6OUT &=~ BIT3;                                    // LED4Ãð
       if(light_value >= 3500)
        {
                          duty=90;
                          TA2CCR1 = Period*duty/100;                   // CCR1 PWM duty cycle
         //                 P6OUT |= BIT4;                                   // LED1ÁÁ
         }
      //  else
        //    P6OUT &=~ BIT4;                                    // LED5Ãð
      if(light_value > 4000)
        {
                          duty=100;
                          TA2CCR1 = Period*duty/100;                   // CCR1 PWM duty cycle
          //                P3OUT |= BIT5;                                   // LED1ÁÁ
         }
        else
            //P3OUT &=~ BIT5;                                     // LED6Ãð
        __delay_cycles(200000);
    }

}

#pragma vector=TIMER0_A0_VECTOR
__interrupt void Timer_A(void)
{
    time=time+1;
    P3OUT ^= BIT5;
}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
